<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鼠路 - 课表首页</title>
  <!-- 引入Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    
    .timetable {
      overflow-x: auto;
      background-color: white;
      margin: 10px;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative; /* 作为水印的父容器 */
    }
    
    /* 水印置于最上层的关键样式 */
    .watermark {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://ts1.tc.mm.bing.net/th/id/R-C.9eb082785fdf2ef9f02a5234c4aa3bdb?rik=1NE7DM1OnLazoA&riu=http%3a%2f%2foss.vismatrix.cn%2fuploads%2f20200921%2fFpXM-6xA6f_0ponloVtciDIF0__-.png&ehk=dB9O9tcuqUZ8b%2fPEcxCQP59JKLrTraoHNxz8vYQOJLE%3d&risl=&pid=ImgRaw&r=0');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.1 !important; /* 强制低透明度 */
      pointer-events: none;
      z-index: 9999 !important; /* 确保最高层级 */
    }
    
    header {
      background-color: #a00000 !important;
      color: white !important;
      padding: 10px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      position: relative !important;
      z-index: 100 !important;
    }
    
    .nav {
      display: flex !important;
      justify-content: space-around !important;
      padding: 10px 0 !important;
      background-color: #a00000 !important;
      width: 100% !important;
      position: relative !important;
      z-index: 100 !important;
    }
    
    .timetable table {
      width: 100% !important;
      border-collapse: collapse !important;
      text-align: center !important;
      position: relative !important;
      z-index: 100 !important;
    }
    
    .timetable th, .timetable td {
      border: 1px solid #ddd !important;
      padding: 6px !important;
      min-width: 70px !important;
      height: 80px !important;
    }
    
    .timetable th {
      background-color: #eee !important;
    }
    
    /* 重命名类名避免冲突 */
    .timetable-placeholder {
      text-align: center !important;
      color: #aaa !important;
    }

    button.btn-custom {        
      background-color: #a00000; /* 初始颜色 */ 
      color: white;
      border: none;
      font-size: 30px;
    }
    
    /* 鼠标悬停时变为白色 */
    button.btn-custom:hover {
      background-color: white;
      color: #a00000; /* 文字变为蓝色 */
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* 添加阴影 */
    }
    
    /* 点击时变为粉色 */
    button.btn-custom:active {
      background-color: #ff69b4; /* 粉色 */
      color: white;
    }
  </style>
</head>
<body>

  <header>
    <h1>鼠路</h1>
    <div>
      <form id="importForm" action="/import_course" method="post" style="display: inline;">
        <textarea name="course_text" id="course_text" style="display: none;"></textarea>
        <button type="button" class="btn btn-custom shadow-sm" onclick="submitForm()">导入课表</button>
      </form>
      <form id="clearForm" action="/clear_schedule" method="post" style="display: inline; margin-left: 10px;">
        <button type="button" class="btn btn-custom shadow-sm" onclick="clearSchedule()">清除课表</button>
      </form>
    </div>
  </header>
  <div class="nav">
    <button type="button" class="btn btn-custom shadow-sm">课表</button>
    <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/map'">地图</button>
    <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/reminder'">提醒</button>
    <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/login'">个人中心</button>
  </div>
  <div class="timetable">
    <div class="watermark"></div>
    {% if not schedule and not request.args.get('cleared_success') %}
      <div class="alert alert-danger" style="margin-bottom:10px;">课表导入失败，请检查格式</div>
    {% endif %}
    <table>
      <thead>
        <tr>
          <th>节次</th>
          <th>一</th>
          <th>二</th>
          <th>三</th>
          <th>四</th>
          <th>五</th>
          <th>六</th>
          <th>日</th>
        </tr>
      </thead>
      <tbody>
        {% set section_times = [
          '08:00~08:45', '08:55~09:40', '09:50~10:35', '10:45~11:30', '11:40~12:25',
          '13:30~14:15', '14:25~15:10', '15:20~16:05', '16:15~17:00'
        ] %}
        {% for i in range(1, 10) %}
          <tr>
            <td>{{ i }}<br>{{ section_times[i-1] }}</td>
            {% for day in ['星期一','星期二','星期三','星期四','星期五','星期六','星期日'] %}
              <td>
                {% if schedule and schedule.get(day) %}
                  {% set found = false %}
                  {% for course in schedule[day] %}
                    {% set section_range = course.time.split('节')[0] %}
                    {% set start_section = section_range.split('-')[0]|int %}
                    {% set end_section = section_range.split('-')[1]|int %}
                    {% if i >= start_section and i <= end_section and not found %}
                      {{ course.course_name }}<br>{{ course.location }}<br>{{ course.weeks }}
                      {% set found = true %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
    // 日志级别配置
    const LOG_LEVELS = {
      DEBUG: 1,
      INFO: 2,
      WARNING: 3,
      ERROR: 4,
      NONE: 5
    };
    const CURRENT_LOG_LEVEL = LOG_LEVELS.DEBUG; // 可调整为不同级别控制日志输出

    // 日志记录函数
    function logDebug(message) {
      if (CURRENT_LOG_LEVEL <= LOG_LEVELS.DEBUG) {
        const timestamp = new Date().toLocaleString();
        const log = `[${timestamp}] [DEBUG] ${message}`;
        console.debug(log);
        saveLogToLocalStorage(log);
      }
    }

    function logInfo(message) {
      if (CURRENT_LOG_LEVEL <= LOG_LEVELS.INFO) {
        const timestamp = new Date().toLocaleString();
        const log = `[${timestamp}] [INFO] ${message}`;
        console.log(log);
        saveLogToLocalStorage(log);
      }
    }

    function logWarning(message) {
      if (CURRENT_LOG_LEVEL <= LOG_LEVELS.WARNING) {
        const timestamp = new Date().toLocaleString();
        const log = `[${timestamp}] [WARNING] ${message}`;
        console.warn(log);
        saveLogToLocalStorage(log);
      }
    }

    function logError(message, errorObj = null) {
      const timestamp = new Date().toLocaleString();
      let log = `[${timestamp}] [ERROR] ${message}`;
      if (errorObj) {
        log += `\n  Error Details: ${errorObj.message}`;
        if (errorObj.stack) {
          log += `\n  Stack Trace: ${errorObj.stack}`;
        }
      }
      console.error(log);
      saveLogToLocalStorage(log);
    }

    // 性能日志函数
    const performanceTimers = {};
    function startTimer(label) {
      performanceTimers[label] = performance.now();
      logDebug(`性能计时开始: ${label}`);
    }

    function endTimer(label) {
      if (performanceTimers[label]) {
        const duration = performance.now() - performanceTimers[label];
        logInfo(`性能计时结束: ${label}，耗时 ${duration.toFixed(2)}ms`);
        delete performanceTimers[label];
      } else {
        logWarning(`性能计时错误: ${label} 未启动`);
      }
    }

    // 保存日志到localStorage
    function saveLogToLocalStorage(log) {
      try {
        let logs = JSON.parse(localStorage.getItem('scheduleLogs') || '[]');
        logs.push(log);
        if (logs.length > 100) logs = logs.slice(-100);
        localStorage.setItem('scheduleLogs', JSON.stringify(logs));
      } catch (e) {
        console.error('Failed to save log to localStorage:', e);
      }
    }

    // 导入课表相关日志
    function submitForm() {
      logInfo("用户点击了【导入课表】按钮");
      try {
        startTimer("导入课表流程");
        const courseText = prompt('请输入课表文本：');
        if (!courseText) {
          logWarning("用户未输入课表文本，取消导入");
          return;
        }
        
        logDebug(`用户输入的课表文本长度: ${courseText.length} 字符`);
        document.getElementById('course_text').value = courseText;
        
        if (courseText.length > 10000) {
          logWarning("课表文本超长(超过10000字符)，可能导致处理缓慢");
        }
        
        document.getElementById('importForm').submit();
        logInfo("课表导入请求已提交到服务器");
        endTimer("导入课表流程");
      } catch (error) {
        logError("导入课表过程中发生错误", error);
        endTimer("导入课表流程");
      }
    }

    // 清除课表相关日志
    function clearSchedule() {
      logInfo("用户点击了【清除课表】按钮");
      try {
        startTimer("清除课表流程");
        if (confirm('确定要清除课表吗？此操作不可恢复。')) {
          logInfo("用户确认清除课表");
          document.getElementById('clearForm').submit();
          logInfo("课表清除请求已提交到服务器");
        } else {
          logInfo("用户取消了清除课表操作");
        }
        endTimer("清除课表流程");
      } catch (error) {
        logError("清除课表过程中发生错误", error);
        endTimer("清除课表流程");
      }
    }

    // 页面加载时的日志
    window.onload = function() {
      try {
        logInfo("课表首页加载开始");
        startTimer("页面加载总耗时");
        
        // 检测页面元素加载情况
        const timetableElement = document.querySelector('.timetable');
        if (!timetableElement) {
          logWarning("未找到课表容器元素");
        }
        
        // 检测URL中的导入/清除成功标识并记录日志
        if (window.location.search.includes('success=1')) {
          logInfo("检测到URL参数：课表导入成功");
        }
        if (window.location.search.includes('cleared=1')) {
          logInfo("检测到URL参数：课表清除成功");
        }
        
        // 检测localStorage中是否有保存的日志
        const savedLogs = JSON.parse(localStorage.getItem('scheduleLogs') || '[]');
        if (savedLogs.length > 50) {
          logWarning(`本地存储的日志数量较多(${savedLogs.length}条)，建议定期清理`);
        }
        
        logInfo("课表首页加载完成");
        endTimer("页面加载总耗时");
      } catch (error) {
        logError("页面加载过程中发生错误", error);
      }
    };

    // 导航按钮点击日志
    document.querySelectorAll('.nav button').forEach(button => {
      button.addEventListener('click', function() {
        try {
          const buttonText = this.textContent.trim();
          logInfo(`用户点击了导航栏的【${buttonText}】按钮`);
          
          // 性能监控
          startTimer(`导航到${buttonText}页面`);
          setTimeout(() => {
            // 模拟导航耗时
            endTimer(`导航到${buttonText}页面`);
          }, 200);
        } catch (error) {
          logError(`导航按钮【${buttonText}】点击事件处理错误`, error);
        }
      });
    });

    // 全局错误捕获
    window.onerror = function(message, source, lineno, colno, error) {
      logError(`全局错误捕获: ${message}`, error);
      return false;
    };

    // Promise未捕获的拒绝
    window.addEventListener('unhandledrejection', function(event) {
      logError(`未处理的Promise拒绝: ${event.reason.message}`, event.reason);
    });

    // 窗口大小变化日志
    window.addEventListener('resize', function() {
      const width = window.innerWidth;
      const height = window.innerHeight;
      logDebug(`窗口大小变化: ${width}x${height}`);
      
      if (width < 576) {
        logInfo("进入移动设备视图模式");
      }
    });

    // 页面可见性变化日志
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        logInfo("页面进入后台(不可见)");
      } else {
        logInfo("页面进入前台(可见)");
      }
    });

</body>
</html>