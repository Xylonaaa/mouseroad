<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>地圖導航</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    .info { 
      margin: 20px; 
      font-size: 16px; 
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .info div {
      margin: 8px 0;
    }
    .course-title {
      font-weight: bold;
      color: #a00000;
      font-size: 18px;
    }
    .time-info {
      color: #666;
    }
    .location-info {
      color: #333;
      font-weight: bold;
    }
    .minutes-left {
      color: #e74c3c;
      font-weight: bold;
    }
    #map-container { 
      width: calc(100% - 40px); 
      height: 400px; 
      border-radius: 8px; 
      overflow: hidden; 
      margin: 0 20px 20px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .nav-button {
      background-color: #a00000;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 20px;
      font-size: 16px;
    }
    .nav-button:hover {
      background-color: #8b0000;
    }
  </style>
  <!-- 高德地图JS API -->
  <script type="text/javascript">
    window.AMapSecurityConfig = {
      securityJsCode: "54e9aeb2c1135158a4ca9d58730727d2"
    };
  </script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=a6f4e9d188dbcb0c77307d7328cbe818"></script>
</head>
<body>
  <div class="info">
    {% if next_course %}
      <div class="course-title">{{ next_course.course }}</div>
      <div class="time-info">课程时间：{{ next_course.time }}</div>
      <div class="time-info">上课周次：{{ next_course.weeks }}</div>
      <div class="location-info">上课地点：{{ next_course.location }}</div>
      <div class="minutes-left">距离上课还有：{{ next_course.minutes_left }} 分钟</div>
      <button class="nav-button" onclick="startWalkingNavigation()">开始步行导航</button>
    {% else %}
      <div style="text-align: center; color: #666; font-size: 18px;">今天没课啦！好好休息吧^^</div>
    {% endif %}
  </div>
  
  <div id="map-container"></div>
  
  <script>
    var map = new AMap.Map('map-container', {
      zoom: 16,
      center: [116.397428, 39.90923]
    });
    
    var currentPosition = null;
    var destinationPosition = null;
    var walking = null;
    
    {% if next_course %}
    // 有下一节课时，搜索并定位到教室
    AMap.plugin(['AMap.PlaceSearch', 'AMap.Geolocation'], function() {
      var placeSearch = new AMap.PlaceSearch({
        city: '全国',
        map: map
      });
      
      var geolocation = new AMap.Geolocation({
        enableHighAccuracy: true,
        timeout: 10000,
        buttonPosition: 'RB',
        zoomToAccuracy: true
      });
      map.addControl(geolocation);
      
      // 先获取当前位置
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          currentPosition = result.position;
          console.log('当前位置:', currentPosition);
          
          // 然后搜索目的地
          var searchAddress = '{{ next_location_address or next_course.location }}';
          placeSearch.search(searchAddress, function(status, result) {
            if (status === 'complete' && result.poiList.pois.length > 0) {
              var poi = result.poiList.pois[0];
              destinationPosition = poi.location;
              map.setCenter(poi.location);
              
              // 添加目的地标记
              new AMap.Marker({
                position: poi.location,
                map: map,
                title: '{{ next_course.location }}',
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
              });
              
              // 添加起点标记
              new AMap.Marker({
                position: currentPosition,
                map: map,
                title: '当前位置',
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'
              });
              
              console.log('目的地位置:', destinationPosition);
            }
          });
        }
      });
    });
    
    // 步行导航函数
    function startWalkingNavigation() {
      if (!currentPosition || !destinationPosition) {
        alert('正在获取位置信息，请稍后再试');
        return;
      }
      
      AMap.plugin('AMap.Walking', function() {
        if (walking) {
          map.remove(walking);
        }
        
        walking = new AMap.Walking({
          map: map,
          panel: "panel"
        });
        
        walking.search(currentPosition, destinationPosition, function(status, result) {
          if (status === 'complete') {
            console.log('步行导航规划完成');
          } else {
            alert('步行导航规划失败，请检查网络连接');
          }
        });
      });
    }
    {% else %}
    // 没有课程时，显示当前位置
    AMap.plugin('AMap.Geolocation', function() {
      var geolocation = new AMap.Geolocation({
        enableHighAccuracy: true,
        timeout: 10000,
        buttonPosition: 'RB',
        zoomToAccuracy: true
      });
      map.addControl(geolocation);
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          map.setCenter(result.position);
          new AMap.Marker({
            position: result.position,
            map: map,
            title: '当前位置'
          });
        }
      });
    });
    {% endif %}
  </script>
</body>
</html> 