<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>地圖導航</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      padding-top: 100px; /* 为固定表头预留空间 */
    }
    .header-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: #a00000;
      z-index: 1000;
    }
    header {
      color: white !important;
      padding: 15px !important;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .nav {
      display: flex !important;
      justify-content: space-around !important;
      padding: 10px 0 !important;
      background-color: #a00000 !important;
      width: 100% !important;
      flex-wrap: nowrap;
    }
    .nav button {
      flex: 1;
      margin: 0 5px;
      white-space: nowrap;
    }
    .btn-custom {
      background-color: #a00000;
      color: white;
      border: none;
      font-size: 18px;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    .btn-custom:hover {
      background-color: white;
      color: #a00000;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .btn-custom:active {
      background-color: #ff69b4;
      color: white;
    }
    .info { 
      margin: 20px; 
      font-size: 16px; 
      background-color: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    }
    .info div {
      margin: 8px 0;
    }
    .course-title {
      font-weight: bold;
      color: #a00000;
      font-size: 20px;
      letter-spacing: 1px;
    }
    .time-info {
      color: #666;
    }
    .location-info {
      color: #333;
      font-weight: bold;
    }
    .minutes-left {
      color: #e74c3c;
      font-weight: bold;
    }
    #map-container { 
      width: calc(100% - 40px); 
      height: 400px; 
      border-radius: 12px; 
      overflow: hidden; 
      margin: 0 20px 20px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      background: #e9ecef;
      position: relative;
    }
    .nav-button {
      background-color: #a00000;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 20px;
      font-size: 16px;
      transition: background 0.2s;
    }
    .nav-button:hover {
      background-color: #8b0000;
    }
    .spinner-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    @media (max-width: 600px) {
      .info, #map-container { margin: 8px; }
      .nav-button { margin: 10px 8px; font-size: 15px; }
      #map-container { height: 260px; }
    }
  </style>
  <!-- 高德地图JS API -->
  <script type="text/javascript">
    window.AMapSecurityConfig = {
      securityJsCode: "54e9aeb2c1135158a4ca9d58730727d2"
    };
  </script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=a6f4e9d188dbcb0c77307d7328cbe818"></script>
</head>
<body>
  <!-- 头部导航容器（横向排列） -->
  <div class="header-container">
    <header>
      <h1>鼠路</h1>
    </header>
    <div class="nav">
      <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/'">课表</button>
      <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/map'">地图</button>
      <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/reminder'">提醒</button>
      <button type="button" class="btn btn-custom shadow-sm" onclick="window.location.href='/profile'">个人中心</button>
    </div>
  </div>
  <div class="info">
    {% if next_course %}
      <div class="course-title">{{ next_course.course }}</div>
      <div class="time-info">课程时间：{{ next_course.time }}</div>
      <div class="time-info">上课周次：{{ next_course.weeks }}</div>
      <div class="location-info">上课地点：{{ next_course.location }}</div>
      <div class="minutes-left">距离上课还有：{{ next_course.minutes_left }} 分钟</div>
      <button class="nav-button" onclick="openAmapNavigation()">开始步行导航</button>
    {% else %}
      <div style="text-align: center; color: #666; font-size: 18px;">今天没课啦！好好休息吧^^</div>
    {% endif %}
  </div>
  
  <div id="map-container">
    <div id="map-loading" class="spinner-overlay">
      <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">地图加载中...</span>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openAmapNavigation() {
      var dest = encodeURIComponent("{{ next_location_address or next_course.location }}");
      window.open('https://uri.amap.com/search?keyword=' + dest + '&src=mouseroad&callnative=0', '_blank');
    }
    
    var map = new AMap.Map('map-container', {
      zoom: 16,
      center: [116.397428, 39.90923]
    });
    
    // 显示加载动画，地图加载完成后隐藏
    var mapLoading = document.getElementById('map-loading');
    map.on('complete', function() {
      if(mapLoading) mapLoading.style.display = 'none';
    });
    
    var currentPosition = null;
    var destinationPosition = null;
    var walking = null;
    
    {% if next_course %}
    // 有下一节课时，搜索并定位到教室
    AMap.plugin(['AMap.PlaceSearch', 'AMap.Geolocation'], function() {
      var placeSearch = new AMap.PlaceSearch({
        city: '全国',
        map: map
      });
      
      var geolocation = new AMap.Geolocation({
        enableHighAccuracy: true,
        timeout: 10000,
        buttonPosition: 'RB',
        zoomToAccuracy: true
      });
      map.addControl(geolocation);
      
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          currentPosition = result.position;
          var searchAddress = '{{ next_location_address or next_course.location }}';
          placeSearch.search(searchAddress, function(status, result) {
            if (status === 'complete' && result.poiList.pois.length > 0) {
              var poi = result.poiList.pois[0];
              destinationPosition = poi.location;
              map.setCenter(poi.location);
              new AMap.Marker({
                position: poi.location,
                map: map,
                title: '{{ next_course.location }}',
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png'
              });
              new AMap.Marker({
                position: currentPosition,
                map: map,
                title: '当前位置',
                icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png'
              });
            }
          });
        }
      });
    });
    {% else %}
    // 没有课程时，显示当前位置
    AMap.plugin('AMap.Geolocation', function() {
      var geolocation = new AMap.Geolocation({
        enableHighAccuracy: true,
        timeout: 10000,
        buttonPosition: 'RB',
        zoomToAccuracy: true
      });
      map.addControl(geolocation);
      geolocation.getCurrentPosition(function(status, result) {
        if (status === 'complete') {
          map.setCenter(result.position);
          new AMap.Marker({
            position: result.position,
            map: map,
            title: '当前位置'
          });
        }
      });
    });
    {% endif %}
  </script>
</body>
</html> 